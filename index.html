<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Confirmaci√≥n de Invitados</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }
    input, button {
      margin: 8px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    .btnOpcion {
      background-color: #4a90e2;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btnOpcion:hover {
      background-color: #357ABD;
    }
    #mensaje {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Confirmaci√≥n de Invitados (Nombre y Apellido)</h1>
  <input type="text" id="nombre" placeholder="Ingrese su nombre">
  <button onclick="verificarInvitado()">Verificar</button>

  <div id="mensaje"></div>

  <div id="opciones" style="display: none;">
    <button class="btnOpcion" onclick="confirmarAsistencia(true)">‚úÖ Voy</button>
    <button class="btnOpcion" onclick="confirmarAsistencia(false)">‚ùå No voy</button>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxqbLfiCOLk835GRMo6niJHzZh67DNVbAideMTDlWNUyXhnNZ8CmruiObyeiJrsDv6n/exec";
    const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLScMvzxj6LL3F-FxWJvlcaBfbgnB-vKVw6zReEeaAOYwtlGJmg/formResponse";
    const ENTRY_NOMBRE = "entry.2062533621";
    const ENTRY_ACOMP = "entry.490039814";
    const ENTRY_CONFIRM = "entry.2005093304";

    let invitados = {};
    let invitadoEncontrado = null;

    function normalizar(texto) {
      return texto.toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim();
    }

    // üî† Funci√≥n para poner may√∫sculas en las primeras letras de cada palabra
    function capitalizarNombre(texto) {
      return texto
        .toLowerCase()
        .split(" ")
        .filter(p => p.trim() !== "")
        .map(p => p.charAt(0).toUpperCase() + p.slice(1))
        .join(" ");
    }

    fetch("invitados.txt")
      .then(response => response.text())
      .then(texto => {
        const lineas = texto.split("\n");
        lineas.forEach(linea => {
          const partes = linea.split(",");
          if (partes.length >= 2) {
            const nombre = partes[0].trim();
            const acompanante = partes.slice(1).join(",").trim();
            const key = normalizar(nombre);
            invitados[key] = acompanante;
          }
        });
        console.log("‚úÖ Invitados cargados:", invitados);
      })
      .catch(err => console.error("Error cargando invitados.txt:", err));

    async function verificarInvitado() {
      const nombre = document.getElementById("nombre").value.trim();
      const msg = document.getElementById("mensaje");
      const opciones = document.getElementById("opciones");

      if (!nombre) {
        msg.textContent = "Por favor, ingrese su nombre.";
        msg.style.color = "red";
        opciones.style.display = "none";
        return;
      }

      const key = normalizar(nombre);
      const acomp = invitados[key];

      if (!acomp) {
        msg.textContent = "Lo siento, no est√°s en la lista.";
        msg.style.color = "red";
        opciones.style.display = "none";
        return;
      }

      msg.textContent = "Verificando si ya est√°s confirmado...";
      msg.style.color = "gray";
      opciones.style.display = "none";

      try {
        const res = await fetch(API_URL);
        const data = await res.json();

        const registrado = data.find(item =>
          item["Nombre del invitado"] &&
          normalizar(item["Nombre del invitado"]) === key
        );

        if (registrado) {
          msg.textContent = `${registrado["Nombre del invitado"]} ya est√° registrad@.`;
          msg.style.color = "orange";
          opciones.style.display = "none";
          invitadoEncontrado = null;
        } else {
          msg.textContent = `${capitalizarNombre(nombre)} va ${acomp}.`;
          msg.style.color = "green";
          opciones.style.display = "block";
          invitadoEncontrado = { nombre: capitalizarNombre(nombre), acompanante: acomp };
        }
      } catch (err) {
        console.error("Error al consultar confirmados:", err);
        msg.textContent = "Error al verificar confirmaci√≥n. Intenta m√°s tarde.";
        msg.style.color = "red";
        opciones.style.display = "none";
      }
    }

    function confirmarAsistencia(viene) {
      if (!invitadoEncontrado) return;

      const textoConfirmacion = `${invitadoEncontrado.nombre} va con ${invitadoEncontrado.acompanante}.`;
      const confirmar = confirm(`${textoConfirmacion}\n\n¬øDesea confirmar que ${viene ? "ASISTIR√Å" : "NO ASISTIR√Å"}?`);

      if (!confirmar) {
        alert("No se envi√≥ ninguna respuesta.");
        return;
      }

      const data = new FormData();
      data.append(ENTRY_NOMBRE, invitadoEncontrado.nombre);
      data.append(ENTRY_ACOMP, invitadoEncontrado.acompanante);
      data.append(ENTRY_CONFIRM, viene ? "Si voy" : "No voy");

      fetch(FORM_URL, {
        method: "POST",
        mode: "no-cors",
        body: data
      })
      .then(() => {
        alert(`Respuesta registrada: ${viene ? "‚úÖ Asistir√°" : "‚ùå No asistir√°"}. ¬°Gracias!`);
        document.getElementById("opciones").style.display = "none";
        document.getElementById("mensaje").textContent = "Tu respuesta fue enviada correctamente.";
        document.getElementById("mensaje").style.color = "green";
      })
      .catch(error => {
        console.error("Error al enviar:", error);
        alert("Hubo un error al confirmar.");
      });
    }
  </script>
</body>
</html>
