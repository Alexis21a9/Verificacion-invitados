<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Confirmaci√≥n de Invitados</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }
    input, button {
      margin: 8px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    .btnOpcion {
      background-color: #4a90e2;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btnOpcion:hover {
      background-color: #357ABD;
    }
    #mensaje {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Confirmaci√≥n de Invitados(Nombre y apellido)</h1>
  <input type="text" id="nombre" placeholder="Ingrese su nombre">
  <button onclick="verificarInvitado()">Verificar</button>

  <div id="mensaje"></div>

  <div id="opciones" style="display: none;">
    <button class="btnOpcion" onclick="confirmarAsistencia(true)">‚úÖ Voy</button>
    <button class="btnOpcion" onclick="confirmarAsistencia(false)">‚ùå No voy</button>
  </div>

<script>
const SHEET_ID = "1UPb80Riwp8pLZkEB3KA3u3qNtC-eHNUEF-4gZULGugI"; // üëà tu ID de hoja
const API_KEY = "AIzaSyBFM3ZBXypWtwGY1zIt0ANiOykL6GbKWVQ";   // üëà tu API key real
const SHEET_NAME = "Respuestas de formulario 1";     // üëà nombre exacto de tu hoja

let invitados = {};
let confirmados = new Set();

// Cargar el archivo invitados.txt
fetch("invitados.txt")
  .then(response => response.text())
  .then(texto => {
    const lineas = texto.split("\n");
    lineas.forEach(linea => {
      const partes = linea.split(",");
      if (partes.length === 2) {
        const nombre = partes[0].trim();
        const acompanante = partes[1].trim();
        // Normalizamos el nombre para b√∫squeda insensible a may√∫sculas y tildes
        const key = nombre.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        invitados[key] = acompanante;
      }
    });
    console.log("Invitados cargados:", invitados);
  })
  .catch(err => console.error("Error cargando invitados.txt:", err));

// Cargar lista de confirmados desde Google Sheets API

const API_URL = "https://script.google.com/macros/s/AKfycbxqbLfiCOLk835GRMo6niJHzZh67DNVbAideMTDlWNUyXhnNZ8CmruiObyeiJrsDv6n/exec";

// El resto del c√≥digo de verificaci√≥n y env√≠o permanece igual
fetch(API_URL)
  .then(res => {
      console.log(res); // esto te muestra el Response
      return res.json();
  })
  .then(data => console.log(data))
  .catch(err => console.error("Error al consultar confirmados:", err));

    function normalizar(texto) {
      return texto.toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
    }

    let invitadoEncontrado = null;

    function verificarInvitado() {
      const nombre = document.getElementById("nombre").value.trim();
      const msg = document.getElementById("mensaje");
      const opciones = document.getElementById("opciones");

      if (!nombre) {
        msg.textContent = "Por favor, ingrese su nombre.";
        msg.style.color = "red";
        opciones.style.display = "none";
        return;
      }

      const key = normalizar(nombre);
      const acomp = invitados[key];

      

       if (!acomp) {
    msg.textContent = "Lo siento, no est√°s en la lista.";
    msg.style.color = "red";
    opciones.style.display = "none";
    invitadoEncontrado = null;
    return;
  }

  // Si est√° en la lista local, consultamos Apps Script para ver si ya confirm√≥
  fetch(API_URL)
    .then(res => res.json())
    .then(data => {
      // data = array de objetos {Nombre, Acompa√±ante, Confirmaci√≥n}
      const registrado = data.find(item => {
    if (!item["Nombre del Invitado"]) return false; // evita undefined
    return normalizar(item["Nombre del Invitado"]) === key;

      if (registrado) {
       msg.textContent = `${registrado["Nombre del invitado"]} ya est√° registrado con ${registrado["Nombre de acompa√±ante/s"]}.`;
        msg.style.color = "orange";
        opciones.style.display = "none"; // no mostramos botones si ya confirm√≥
        invitadoEncontrado = null;
      } else {
        msg.textContent = `${nombre.toUpperCase()} va ${acomp}.`;
        msg.style.color = "green";
        opciones.style.display = "block"; // mostramos botones para confirmar
        invitadoEncontrado = { nombre, acompanante: acomp };
      }
    })
    .catch(err => {
      console.error("Error al consultar confirmados:", err);
      msg.textContent = "Error al verificar confirmaci√≥n. Intenta m√°s tarde.";
      msg.style.color = "red";
      opciones.style.display = "none";
    });
}

    function confirmarAsistencia(viene) {
      if (!invitadoEncontrado) return;

      // üü¢ Mostrar mensaje de confirmaci√≥n antes de enviar
      const textoConfirmacion = `${invitadoEncontrado.nombre} va con ${invitadoEncontrado.acompanante}.`;
      const confirmar = confirm(`${textoConfirmacion}\n\n¬øDesea confirmar que ${viene ? "ASISTIR√Å" : "NO ASISTIR√Å"}?`);

      if (!confirmar) {
        alert("No se envi√≥ ninguna respuesta.");
        return;
      }

      // URL de Google Form
      const formURL = "https://docs.google.com/forms/d/e/1FAIpQLScMvzxj6LL3F-FxWJvlcaBfbgnB-vKVw6zReEeaAOYwtlGJmg/formResponse";

      // Campos del formulario (IDs correctos)
      const data = new FormData();
      data.append("entry.2062533621", invitadoEncontrado.nombre);         // Nombre del invitado
      data.append("entry.490039814", invitadoEncontrado.acompanante);   // Acompa√±ante
      data.append("entry.2005093304", viene ? "Si voy" : "No voy"); // Confirmaci√≥n

      fetch(formURL, {
        method: "POST",
        mode: "no-cors",
        body: data
      })
      .then(() => {
        alert(`Respuesta registrada: ${viene ? "‚úÖ Asistir√°" : "‚ùå No asistir√°"}. ¬°Gracias!`);
        document.getElementById("opciones").style.display = "none";
      })
      .catch(error => {
        console.error("Error al enviar:", error);
        alert("Hubo un error al confirmar.");
      });
    }
  </script>
</body>
</html>
